// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Users
model User {
    id          String     @id @default(uuid())
    email       String     @unique
    fullName    String?
    phoneNumber String?
    address     String?
    role        String     @default("user") // "user", "admin"
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt
    orders      Order[]
    cart        CartItem[]
    addresses   Address[]

    @@index([email])
    @@index([role])
}

// Products
model Product {
    id               String   @id @default(uuid())
    name             String
    slug             String   @unique
    description      String?  @db.Text
    mainImage        String?
    additionalImages String[] // Pastikan array string murni, tidak boleh null
    basePrice        Float?
    baseStock        Int?
    hasVariations    Boolean  @default(false)
    specialLabel     String? // Bisa digunakan untuk "featured", "new", dll
    weight           Int? // in grams
    dimensions       Json? // {width, length, height}
    seo              Json? // {title, description, keywords, og_image}
    searchKeywords   String[]

    // Kolom untuk full-text search
    nameVector        Unsupported("tsvector")?
    descriptionVector Unsupported("tsvector")?
    searchVector      Unsupported("tsvector")?

    // Relasi dengan Category dan Collection
    categoryId   String?
    category     Category?   @relation(fields: [categoryId], references: [id])
    collectionId String?
    collection   Collection? @relation(fields: [collectionId], references: [id])

    // Relasi dengan model variasi
    variations    ProductVariation[]
    priceVariants PriceVariant[]

    // Relasi dengan model lainnya
    cartItems  CartItem[]
    orderItems OrderItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([categoryId])
    @@index([collectionId])
    @@index([slug])
    @@index([specialLabel])
    @@index([name])
    @@index([basePrice])
    @@index([searchKeywords])
}

// Categories
model Category {
    id        String    @id @default(uuid())
    name      String    @unique
    products  Product[]
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
}

// Collections
model Collection {
    id        String    @id @default(uuid())
    name      String    @unique
    products  Product[]
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
}

// FAQs
model FAQ {
    id        String   @id @default(uuid())
    question  String
    answer    String   @db.Text
    order     Int      @default(0)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([order])
}

// Articles
model Article {
    id             String   @id @default(uuid())
    title          String
    slug           String   @unique
    content        String   @db.Text
    excerpt        String?  @db.Text
    featured_image Json? // {url: string, alt: string}
    status         String // "draft", "published"
    meta           Json? // {title: string, description: string, og_image: string}
    author         Json? // {id: string, name: string}
    createdAt      DateTime @default(now()) // Diubah dari created_at untuk konsistensi penamaan
    updatedAt      DateTime @updatedAt // Diubah dari updated_at untuk konsistensi penamaan
    // Tambahan: kategori artikel untuk pengelompokan
    category       String?

    @@index([slug])
    @@index([status])
    @@index([title]) // Tambahan untuk SEO optimization
    @@index([category])
    @@index([createdAt]) // Diubah dari created_at untuk konsistensi penamaan
}

// Banners
model Banner {
    id        String   @id @default(uuid())
    title     String
    imageUrl  String
    url       String?
    active    Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt // Diubah dari @default(now()) ke @updatedAt
}

// SEO Settings
model SEOSetting {
    id          String   @id @default(uuid())
    pageId      String   @unique // "homepage", "about", "faq", etc.
    title       String
    description String
    keywords    String?
    og_image    String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt // Perbaikan dari @default(now()) ke @updatedAt
}

// Cart Items
model CartItem {
    id              String   @id @default(uuid())
    userId          String
    productId       String
    name            String
    price           Float
    quantity        Int
    image           String?
    variationImage  String?
    selectedOptions Json? // {variationName: optionName}
    variationKey    String?
    user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@unique([userId, productId, variationKey])
    @@index([userId])
    @@index([productId])
}

// Orders
model Order {
    id           String        @id @default(uuid())
    userId       String
    status       String // "pending", "processing", "shipped", "delivered", "cancelled"
    totalAmount  Float
    shippingInfo Json // {address, city, postalCode, etc.}
    paymentInfo  Json? // {method, transactionId, etc.}
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @updatedAt
    user         User          @relation(fields: [userId], references: [id])
    items        OrderItem[]
    statusLogs   OrderStatus[]

    @@index([userId])
    @@index([status])
    @@index([createdAt])
}

// Order Items
model OrderItem {
    id              String   @id @default(uuid())
    orderId         String
    productId       String
    quantity        Int
    price           Float
    selectedOptions Json? // {variationName: optionName}
    order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product         Product  @relation(fields: [productId], references: [id])
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@index([orderId])
    @@index([productId])
}

// Model untuk variasi produk (contoh: Warna, Ukuran, dll)
model ProductVariation {
    id        String                   @id @default(uuid())
    productId String
    name      String // Contoh: "Warna", "Ukuran"
    product   Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
    options   ProductVariationOption[]
    createdAt DateTime                 @default(now())
    updatedAt DateTime                 @updatedAt

    @@index([productId])
}

// Model untuk opsi dari variasi (contoh: Merah, Hijau untuk Warna; S, M, L untuk Ukuran)
model ProductVariationOption {
    id            String                 @id @default(uuid())
    variationId   String
    name          String // Contoh: "Merah", "XL"
    imageUrl      String?
    variation     ProductVariation       @relation(fields: [variationId], references: [id], onDelete: Cascade)
    priceVariants PriceVariantToOption[]
    createdAt     DateTime               @default(now())
    updatedAt     DateTime               @updatedAt

    @@index([variationId])
}

// Model untuk varian harga dan stok berdasarkan kombinasi opsi
model PriceVariant {
    id              String                 @id @default(uuid())
    productId       String
    product         Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
    price           Float
    stock           Int
    combinationKey  String // Contoh: "color-1_size-2" untuk kombinasi unik
    descriptiveName String? // contoh: "Merah - XL"
    options         PriceVariantToOption[] // Pastikan relasi ini didefinisikan dengan benar
    createdAt       DateTime               @default(now())
    updatedAt       DateTime               @updatedAt

    @@unique([productId, combinationKey])
    @@index([productId])
}

// Tabel penghubung many-to-many antara PriceVariant dan ProductVariationOption
model PriceVariantToOption {
    priceVariantId String
    optionId       String
    priceVariant   PriceVariant           @relation(fields: [priceVariantId], references: [id], onDelete: Cascade)
    option         ProductVariationOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

    @@id([priceVariantId, optionId])
}

// Model untuk alamat pengiriman user
model Address {
    id          String   @id @default(uuid())
    userId      String
    fullName    String
    phoneNumber String
    province    String
    city        String
    district    String
    postalCode  String
    addressLine String
    isDefault   Boolean  @default(false)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt // Diubah dari @default(now()) ke @updatedAt
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

// Model untuk tracking status pesanan
model OrderStatus {
    id        String   @id @default(uuid())
    orderId   String
    status    String
    notes     String?
    createdAt DateTime @default(now())
    order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

    @@index([orderId])
}
